# EPUB 章节导出工具 v2.0

## 概述

这是基于标准方法重新实现的 EPUB 章节导出工具，旨在解决原版本中可能存在的内容丢失问题。

## 主要改进

### v2.0 相比 v1.0 的改进：

1. **移除复杂的自制锚点处理算法**
   - 不再使用复杂的 `filepos` 处理逻辑
   - 避免过度"智能"的内容分割

2. **采用保守但可靠的方法**
   - 优先使用完整的文档内容
   - 只在明确的情况下进行锚点分割
   - 避免重复处理同一文件

3. **基于 ebooklib 标准方法**
   - 遵循 EPUB 标准的 TOC 和 Spine 处理
   - 使用库提供的标准 API

4. **增强的调试功能**
   - 详细的结构分析
   - 清晰的处理过程日志

## 使用方法

### 基本用法

```bash
# 使用默认设置导出
python epub_exporter_v2.py book.epub

# 指定输出目录和格式
python epub_exporter_v2.py book.epub -o ./chapters -f txt

# 启用调试模式
python epub_exporter_v2.py book.epub -d
```

### 研究 EPUB 结构

```bash
# 分析 EPUB 文件的内部结构
python research_ebooklib.py book.epub
```

### 对比两个版本

```bash
# 比较 v1 和 v2 的提取结果
python compare_versions.py book.epub
```

## 核心设计原则

### 1. 保守优于激进
- 宁可保留更多内容，也不要丢失内容
- 避免复杂的内容分割算法

### 2. 标准优于自制
- 使用 ebooklib 提供的标准方法
- 遵循 EPUB 规范

### 3. 透明优于黑盒
- 提供详细的调试信息
- 清晰的处理逻辑

## 处理策略

### TOC (目录) 处理
1. 优先使用 EPUB 的 TOC 结构
2. 对于有锚点的条目：
   - 如果能找到明确的锚点位置，进行简单分割
   - 如果锚点处理失败，使用整个文件内容
   - 避免重复处理同一文件

### Spine (阅读顺序) 处理
1. 当 TOC 不可用时，按 Spine 顺序处理
2. 每个文档项目作为一个章节
3. 从内容中提取标题

### 锚点处理
1. 只处理明确的 `id` 和 `name` 属性
2. 使用简单的正则匹配
3. 失败时回退到完整文件内容

## 文件说明

- `epub_exporter_v2.py` - 主要的导出工具
- `research_ebooklib.py` - EPUB 结构分析工具
- `compare_versions.py` - 版本对比工具
- `test_content_extraction.py` - v1 版本的测试工具

## 预期效果

相比 v1 版本，v2 版本应该：

1. **减少内容丢失**
   - 更保守的处理策略
   - 避免过度分割

2. **提高可靠性**
   - 基于标准方法
   - 减少边界情况错误

3. **增强可调试性**
   - 详细的处理日志
   - 清晰的对比工具

## 注意事项

1. **可能的权衡**
   - 某些情况下可能产生较大的章节文件
   - 锚点分割可能不如 v1 版本"智能"

2. **建议的使用流程**
   - 先用调试模式分析 EPUB 结构
   - 对比 v1 和 v2 的结果
   - 根据需要选择合适的版本

3. **测试建议**
   - 在多种不同的 EPUB 文件上测试
   - 关注内容完整性而非章节数量
